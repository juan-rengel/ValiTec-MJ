<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Valitec MJ - Painel de Controle</title>
<link rel="stylesheet" href="dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
#painelGerente {
  margin-top: 2rem;
  background: #141923;
  padding: 1rem 2rem;
  border-radius: 12px;
  box-shadow: 0 0 15px #00ffff33;
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}
#painelGerente input, #painelGerente button {
  width: 100%;
  margin: .5rem 0;
  padding: .6rem;
  border-radius: 8px;
  border: none;
  background: #0a0f1f;
  color: #e6eef6;
}
#painelGerente button {
  background: #00ffff22;
  cursor: pointer;
  transition: 0.3s;
}
#painelGerente button:hover {
  background: #00ffff55;
}
</style>
</head>
<body>

<header>
  <div class="logo">ValiTec MJ</div>
  <div class="menu-btn" onclick="toggleMenu()">‚ò∞</div>
</header>

<nav id="menu">
  <ul>
    <li onclick="showSection('dashboard')">üìä Dashboard</li>
    <li onclick="showSection('produtos')">üõí Produtos</li>
    <li onclick="showSection('graficos')">üìà Gr√°ficos</li>
    <li onclick="showSection('exportar')">üì§ Exportar</li>
    <li onclick="showSection('perfil')">üë§ Perfil</li>
  </ul>
</nav>

  <div class="main">
  <section id="dashboard" class="active">
    <h2>üìä Dashboard</h2>
    <p>Resumo geral das lojas e produtos.</p>
  </section>

  <section id="produtos">
    <h2>üõí Produtos</h2>
    <p>Cadastro e controle de produtos em rebaixa.</p>
  </section>

  <section id="graficos">
    <h2>üìà Gr√°ficos</h2>
    <p>Visualiza√ß√£o dos dados por loja.</p>
  </section>

  <section id="exportar">
    <h2>üì§ Exportar</h2>
    <p>Exporta√ß√£o de relat√≥rios e planilhas.</p>
  </section>

  <section id="perfil">
    <h2>üë§ Perfil Gerencial</h2>
    <p>Foto, nome completo, loja e WhatsApp configurados.</p>
  </section>
</div>

  <script>
    // Alternar menu lateral no mobile
    function toggleMenu() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Mostrar se√ß√µes
    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    // ======= Anima√ß√£o de Part√≠culas =======
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let particlesArray = [];

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function resizeCanvas() {
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      initParticles();
    }

    function initParticles() {
      particlesArray = [];
      for (let i = 0; i < 80; i++) {
        particlesArray.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          size: Math.random() * 2 + 1,
          speedX: (Math.random() - 0.5) * 0.5,
          speedY: (Math.random() - 0.5) * 0.5
        });
      }
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#00c6ff";
      for (let p of particlesArray) {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        p.x += p.speedX;
        p.y += p.speedY;
        if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
        if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
      }
      requestAnimationFrame(animateParticles);
    }
    animateParticles();
  </script>

 <!-- ========================================================= -->
<!-- ====  PARTES 2 + 3 ‚Äî FIREBASE + PRODUTOS COMPLETOS  ==== -->
<!-- ========================================================= -->
<script type="module">
  // ======== CONFIG FIREBASE ========
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, signOut 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { 
    getFirestore, addDoc, collection, getDocs, Timestamp 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { 
    getStorage, ref, uploadBytes, getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // ======== SUA CONFIG FIREBASE ========
  const firebaseConfig = {
    apiKey: "AIzaSyDPIlkTLbaeUiuvfvijWf5fofREw5oE8ic",
    authDomain: "valitec-mj.firebaseapp.com",
    projectId: "valitec-mj",
    storageBucket: "valitec-mj.firebasestorage.app",
    messagingSenderId: "616592039657",
    appId: "1:616592039657:web:3827a890474111be85da78"
  };

  // ======== INICIALIZA√á√ÉO ========
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // === PARTE 2 CORRIGIDA: GR√ÅFICOS + EXPORT (COLE AQUI DENTRO DO SEU <script type="module">) ===

// requer: Chart.js (cdn), XLSX (cdn), jsPDF (cdn) inclu√≠dos no HTML (voc√™ j√° tem essas tags).
// usa a vari√°vel `db` j√° existente (getFirestore(app))

import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

async function carregarProdutos() {
  const qSnap = await getDocs(collection(db, "produtos"));
  return qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
}

// garante que os elementos da UI existam
function ensureUI() {
  // se√ß√£o gr√°ficos
  let secG = document.getElementById("graficos");
  if (!secG) {
    secG = document.createElement("section");
    secG.id = "graficos";
    document.querySelector(".main").appendChild(secG);
  }
  secG.innerHTML = `
    <h2>üìä An√°lise de Vencimentos</h2>
    <div class="card chart-container">
      <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:.6rem">
        <select id="filterLoja"><option value="">Todas as lojas</option></select>
        <select id="filterSetor"><option value="">Todos os setores</option></select>
        <button id="btnRefresh">üîÑ Atualizar</button>
      </div>
      <canvas id="grafSetor" height="140"></canvas>
      <canvas id="grafStatus" height="120" style="margin-top:18px;"></canvas>
      <canvas id="grafLoja" height="120" style="margin-top:18px;"></canvas>
    </div>
  `;

  // se√ß√£o exportar
  let secE = document.getElementById("exportar");
  if (!secE) {
    secE = document.createElement("section");
    secE.id = "exportar";
    document.querySelector(".main").appendChild(secE);
  }
  secE.innerHTML = `
    <h2>üì§ Exportar Dados</h2>
    <div class="card">
      <div style="display:flex;gap:.6rem;flex-wrap:wrap">
        <button id="btnPDF">üìÑ Gerar PDF</button>
        <button id="btnExcel">üìä Exportar Excel</button>
      </div>
      <p style="margin-top:.6rem;color:var(--muted)">O PDF incluir√° o logo da ValiTec MJ e tema dark/ciano.</p>
    </div>
  `;
}

let chartSetor = null;
let chartStatus = null;
let chartLoja = null;

function destroyCharts() {
  if (chartSetor) { chartSetor.destroy(); chartSetor = null; }
  if (chartStatus) { chartStatus.destroy(); chartStatus = null; }
  if (chartLoja) { chartLoja.destroy(); chartLoja = null; }
}

function buildCounts(produtos, lojaFilter = "", setorFilter = "") {
  const contSetor = {};
  const contStatus = {};
  const contLoja = {};
  produtos.forEach(p => {
    if (lojaFilter && (p.loja || "") !== lojaFilter) return;
    if (setorFilter && (p.setor || "") !== setorFilter) return;

    const setor = p.setor || "Sem Setor";
    const status = p.status || "sem status";
    const loja = p.loja || "Sem Loja";

    contSetor[setor] = (contSetor[setor] || 0) + 1;
    contStatus[status] = (contStatus[status] || 0) + 1;
    contLoja[loja] = (contLoja[loja] || 0) + 1;
  });
  return { contSetor, contStatus, contLoja };
}

async function popularFiltros(produtos) {
  const selLoja = document.getElementById("filterLoja");
  const selSetor = document.getElementById("filterSetor");
  const lojas = Array.from(new Set(produtos.map(p => p.loja || "Sem Loja")));
  const setores = Array.from(new Set(produtos.map(p => p.setor || "Sem Setor")));

  // limpa e adiciona
  selLoja.innerHTML = `<option value="">Todas as lojas</option>` + lojas.map(l => `<option value="${l}">${l}</option>`).join("");
  selSetor.innerHTML = `<option value="">Todos os setores</option>` + setores.map(s => `<option value="${s}">${s}</option>`).join("");
}

function criarGraficos(contSetor, contStatus, contLoja) {
  destroyCharts();

  const ctxS = document.getElementById("grafSetor").getContext("2d");
  chartSetor = new Chart(ctxS, {
    type: "bar",
    data: {
      labels: Object.keys(contSetor),
      datasets: [{ label: "Produtos por Setor", data: Object.values(contSetor), backgroundColor: "rgba(0,255,255,0.35)", borderColor: "#00ffff", borderWidth: 1 }]
    },
    options: {
      plugins: { legend: { labels: { color: "#00ffff" } } },
      scales: {
        x: { ticks: { color: "#fff" } },
        y: { ticks: { color: "#fff" } }
      }
    }
  });

  const ctxSt = document.getElementById("grafStatus").getContext("2d");
  chartStatus = new Chart(ctxSt, {
    type: "pie",
    data: { labels: Object.keys(contStatus), datasets: [{ data: Object.values(contStatus), backgroundColor: ["#00ffff","#ffa500","#00ff7f","#ff4444"] }] },
    options: { plugins: { legend: { labels: { color: "#fff" } } } }
  });

  const ctxL = document.getElementById("grafLoja").getContext("2d");
  chartLoja = new Chart(ctxL, {
    type: "doughnut",
    data: { labels: Object.keys(contLoja), datasets: [{ data: Object.values(contLoja), backgroundColor: ["#00ffff88","#0099ff88","#00557788"] }] },
    options: { plugins: { legend: { labels: { color: "#fff" } } } }
  });
}

async function atualizarPainel() {
  const produtos = await carregarProdutos();
  await popularFiltros(produtos);

  const lojaFilter = document.getElementById("filterLoja")?.value || "";
  const setorFilter = document.getElementById("filterSetor")?.value || "";

  const { contSetor, contStatus, contLoja } = buildCounts(produtos, lojaFilter, setorFilter);
  criarGraficos(contSetor, contStatus, contLoja);
}

// inicializa UI e eventos
ensureUI();
document.getElementById("btnRefresh")?.addEventListener("click", atualizarPainel);
document.getElementById("filterLoja")?.addEventListener("change", atualizarPainel);
document.getElementById("filterSetor")?.addEventListener("change", atualizarPainel);

// hooks export
document.getElementById("btnPDF")?.addEventListener("click", async () => {
  const produtos = await carregarProdutos();
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) return alert("jsPDF n√£o carregado");

  const doc = new jsPDF({ unit: "pt", format: "a4" });
  // cabe√ßalho escuro
  doc.setFillColor(10, 15, 21);
  doc.rect(0, 0, doc.internal.pageSize.getWidth(), 60, "F");
  doc.setTextColor(0, 255, 255);
  doc.setFontSize(16);
  doc.text("ValiTec MJ ‚Äî Relat√≥rio de Produtos", 40, 40);

  // logo (se quiser usar PNG externo)
  const logoUrl = "https://juan-rengel.github.io/MJTECNOLOGI2025/img/logo_valitec_mj.png";
  try {
    // tenta carregar imagem (assume CORS ok)
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = logoUrl;
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });
    // desenha logo
    doc.addImage(img, "PNG", doc.internal.pageSize.getWidth() - 110, 10, 80, 40);
  } catch (e) {
    // n√£o fatal: continua sem logo
    console.warn("Logo n√£o foi adicionada ao PDF:", e);
  }

  doc.setTextColor(255,255,255);
  doc.setFontSize(10);
  let y = 80;
  produtos.forEach((p, idx)=>{
    const linha = `${idx+1}. ${p.nome || p.nomeProduto || "‚Äî"} | Setor: ${p.setor || "‚Äî"} | Loja: ${p.loja || "‚Äî"} | Status: ${p.status || "‚Äî"} | Validade: ${p.validade || "‚Äî"}`;
    doc.text(linha, 40, y);
    y += 16;
    if (y > doc.internal.pageSize.getHeight() - 40) { doc.addPage(); y = 40; }
  });

  doc.save(`ValiTecMJ_Relatorio_${new Date().toISOString().slice(0,10)}.pdf`);
});

document.getElementById("btnExcel")?.addEventListener("click", async () => {
  const produtos = await carregarProdutos();
  const dados = produtos.map(p => ({
    Nome: p.nome || p.nomeProduto || "",
    Codigo: p.codigo || p.codigoBarras || "",
    Lote: p.lote || "",
    Setor: p.setor || "",
    Loja: p.loja || "",
    Status: p.status || "",
    Validade: p.validade || ""
  }));
  const ws = XLSX.utils.json_to_sheet(dados);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Produtos");
  XLSX.writeFile(wb, `ValiTecMJ_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
});

// carregamento inicial
atualizarPainel().catch(err => console.error("erro painel:", err));

  // ======== CHECAR LOGIN ========
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "index.html"; // volta se n√£o logado
    } else {
      console.log("Logado:", user.email);
    }
  });

  // ======== LOGOUT ========
  document.getElementById("logoutBtn")?.addEventListener("click", () => {
    signOut(auth).then(() => window.location.href = "index.html");
  });

  // =========================================================
  // ======== CADASTRO E LISTAGEM DE PRODUTOS ========
  // =========================================================
  const secProdutos = document.getElementById("produtos");
  secProdutos.innerHTML = `
  <h2>üì¶ Cadastro de Produtos</h2>
  <form id="formProduto" class="card">
    <label>Nome do Produto:</label>
    <input type="text" id="nomeProduto" required>

    <label>C√≥digo de Barras:</label>
    <input type="text" id="codigoBarras" placeholder="Use o leitor da c√¢mera">
    <button type="button" id="scanBtn">üì∑ Ler C√≥digo</button>

    <label>Lote:</label>
    <input type="text" id="lote" required>

    <label>Setor:</label>
    <select id="setor">
      <option>Mercearia</option>
      <option>Bebidas</option>
      <option>Frios</option>
      <option>Higiene</option>
      <option>Limpeza</option>
      <option>A√ßougue</option>
    </select>

    <label>Data de Validade:</label>
    <input type="date" id="validade" required>

    <label>Foto do Produto:</label>
    <input type="file" id="fotoProduto" accept="image/*">

    <label>Status:</label>
    <select id="status">
      <option value="pendente">Pendente</option>
      <option value="rebaixado">Rebaixado</option>
      <option value="recuperado">Recuperado</option>
      <option value="vencido">Vencido</option>
    </select>

    <button type="submit">üíæ Salvar Produto</button>
  </form>

  <hr>
  <h3>üìã Lista de Produtos</h3>
  <div id="listaProdutos"></div>
  `;

  const formProduto = document.getElementById("formProduto");
  const listaProdutos = document.getElementById("listaProdutos");

  // ======== SALVAR PRODUTO ========
  formProduto.addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = document.getElementById("fotoProduto").files[0];
    let fotoURL = "";

    try {
      if (file) {
        const storageRef = ref(storage, "produtos/" + Date.now() + "-" + file.name);
        await uploadBytes(storageRef, file);
        fotoURL = await getDownloadURL(storageRef);
      }

      const dados = {
        nome: nomeProduto.value,
        codigo: codigoBarras.value || "",
        lote: lote.value,
        setor: setor.value,
        validade: validade.value,
        status: status.value,
        foto: fotoURL,
        criadoPor: auth.currentUser?.email || "admin",
        criadoEm: Timestamp.now()
      };

      await addDoc(collection(db, "produtos"), dados);
      alert("‚úÖ Produto cadastrado com sucesso!");
      formProduto.reset();
      listarProdutos();
    } catch (err) {
      alert("Erro ao salvar produto: " + err.message);
    }
  });

  // ======== LISTAR PRODUTOS ========
  async function listarProdutos() {
    const snap = await getDocs(collection(db, "produtos"));
    listaProdutos.innerHTML = "";
    const hoje = new Date();

    snap.forEach((docu) => {
      const p = docu.data();
      const validade = new Date(p.validade);
      const diffDias = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
      let cor = "";
      if (diffDias <= 10 && diffDias >= 7) cor = "yellow";
      else if (diffDias <= 6 && diffDias >= 4) cor = "orange";
      else if (diffDias <= 3) cor = "red";

      const card = document.createElement("div");
      card.style = `
        border: 1px solid ${cor};
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.03);
      `;
      card.innerHTML = `
        <b>${p.nome}</b> (${p.setor})<br>
        <small>Lote: ${p.lote}</small><br>
        <small>Validade: ${p.validade} (${diffDias} dias)</small><br>
        <small>Status: ${p.status}</small><br>
        ${p.foto ? `<img src="${p.foto}" width="100">` : ""}
        <br>
        <button onclick="enviarWhats('${p.nome}','${p.lote}','${p.setor}','${p.validade}','${p.status}')">üì© WhatsApp</button>
      `;
      listaProdutos.appendChild(card);

      // WhatsApp autom√°tico quando faltam 5 dias
      if (diffDias === 5) {
        enviarWhats(p.nome, p.lote, p.setor, p.validade, p.status);
      }
    });
  }

  // ======== ENVIO WHATSAPP ========
  window.enviarWhats = function(nome, lote, setor, validade, status) {
    const msg = `üö® *Produto Pr√≥ximo ao Vencimento!*\n\nüì¶ *${nome}*\nüî¢ Lote: ${lote}\nüè¨ Setor: ${setor}\nüìÖ Validade: ${validade}\n‚öôÔ∏è Status: ${status}\n\nPor favor, verifique e realize a rebaixa.`;
    const link = `https://wa.me/?text=${encodeURIComponent(msg)}`;
    window.open(link, "_blank");
  }

  listarProdutos();

  // ======== LEITOR DE C√ìDIGO DE BARRAS ========
  const scanBtn = document.getElementById("scanBtn");
  scanBtn.addEventListener("click", async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
      const video = document.createElement("video");
      video.srcObject = stream;
      video.play();
      document.body.appendChild(video);
      alert("üì∑ Leitor de c√≥digo simulado. (vers√£o real pode usar biblioteca 'QuaggaJS')");
    } catch (err) {
      alert("Erro ao acessar c√¢mera: " + err.message);
    }
  });
</script>

<!-- === PARTE 4 ‚Äî GR√ÅFICOS E EXPORTA√á√ïES (CORRIGIDA) === -->
<!-- libs externas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // usa o mesmo 'db' criado na Parte 2
  const secGraficos = document.getElementById("graficos");

  if (secGraficos) {
    secGraficos.innerHTML = `
      <h2>üìä An√°lise de Vencimentos</h2>
      <div class="controls" style="margin-bottom:1rem">
        <button id="btnExcel">üìë Exportar Excel</button>
        <button id="btnPDF">üìÑ Exportar PDF</button>
      </div>
      <canvas id="grafSetor" style="max-height:300px"></canvas>
      <canvas id="grafStatus" style="max-height:300px;margin-top:30px"></canvas>
    `;
  }

  async function gerarGraficos() {
    const snap = await db.collection("produtos").get();
    const dados = snap.docs.map(d => d.data());

    const setores = {};
    const statusContagem = {};

    dados.forEach(p => {
      setores[p.setor] = (setores[p.setor] || 0) + 1;
      statusContagem[p.status || "sem status"] =
        (statusContagem[p.status || "sem status"] || 0) + 1;
    });

    // gr√°fico por setor
    const ctx1 = document.getElementById("grafSetor");
    new Chart(ctx1, {
      type: "bar",
      data: {
        labels: Object.keys(setores),
        datasets: [{
          label: "Produtos por Setor",
          data: Object.values(setores),
          backgroundColor: "rgba(0,255,255,0.4)",
          borderColor: "#00ffff",
          borderWidth: 2
        }]
      },
      options: {
        plugins: { legend: { labels: { color: "#0ff" } } },
        scales: {
          x: { ticks: { color: "#fff" } },
          y: { ticks: { color: "#fff" } }
        }
      }
    });

    // gr√°fico por status
    const ctx2 = document.getElementById("grafStatus");
    new Chart(ctx2, {
      type: "pie",
      data: {
        labels: Object.keys(statusContagem),
        datasets: [{
          data: Object.values(statusContagem),
          backgroundColor: ["#00ffff", "#ffa500", "#00ff7f", "#ff4444"]
        }]
      },
      options: {
        plugins: { legend: { labels: { color: "#fff" } } }
      }
    });
  }

  gerarGraficos();

  // ======== EXPORTAR EXCEL ========
  document.getElementById("btnExcel").addEventListener("click", async () => {
    const snap = await db.collection("produtos").get();
    const dados = snap.docs.map(d => d.data());
    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produtos");
    XLSX.writeFile(wb, "valitec_produtos.xlsx");
  });

  // ======== EXPORTAR PDF ========
  document.getElementById("btnPDF").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    const snap = await db.collection("produtos").get();
    const dados = snap.docs.map(d => d.data());

    pdf.setFontSize(14);
    pdf.text("Relat√≥rio de Produtos - Valitec MJ", 14, 20);
    pdf.setFontSize(10);

    let y = 30;
    dados.forEach((p, i) => {
      pdf.text(
        `${i + 1}. ${p.nome} | Setor: ${p.setor} | Validade: ${p.validade} | Status: ${p.status}`,
        14,
        y
      );
      y += 8;
      if (y > 270) { pdf.addPage(); y = 20; }
    });

    pdf.save("valitec_produtos.pdf");
  });


</script>


<!-- === PARTE 5 ‚Äî PAINEL ADMINISTRATIVO (GERAL E POR LOJA) === -->
<script>
  const painelAdmin = document.createElement("section");
  painelAdmin.classList.add("card");
  painelAdmin.innerHTML = `
    <h2>üè™ Painel Administrativo - Supermercados</h2>
    <div class="filtros" style="margin-bottom:1rem;">
      <label>Supermercado:</label>
      <select id="filtroLoja">
        <option value="">Todos</option>
      </select>
      <label>Setor:</label>
      <select id="filtroSetor">
        <option value="">Todos</option>
      </select>
      <label>Status:</label>
      <select id="filtroStatus">
        <option value="">Todos</option>
        <option value="pendente">Pendente</option>
        <option value="rebaixado">Rebaixado</option>
        <option value="vencido">Vencido</option>
        <option value="recuperado">Recuperado</option>
      </select>
      <button id="btnFiltrar">üîç Filtrar</button>
    </div>
    <div id="tabelaAdmin" style="overflow:auto;max-height:400px"></div>
    <canvas id="grafAdmin" style="margin-top:2rem;max-height:350px;"></canvas>
  `;
  document.body.appendChild(painelAdmin);

  // carregar listas para filtros
  async function carregarFiltros() {
    const snap = await db.collection("produtos").get();
    const produtos = snap.docs.map(d => d.data());

    const lojas = [...new Set(produtos.map(p => p.loja || "Sem Loja"))];
    const setores = [...new Set(produtos.map(p => p.setor || "Sem Setor"))];

    const filtroLoja = document.getElementById("filtroLoja");
    lojas.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l;
      opt.textContent = l;
      filtroLoja.appendChild(opt);
    });

    const filtroSetor = document.getElementById("filtroSetor");
    setores.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      filtroSetor.appendChild(opt);
    });
  }

  carregarFiltros();

  async function gerarTabelaEGr√°fico() {
    const filtroLoja = document.getElementById("filtroLoja").value;
    const filtroSetor = document.getElementById("filtroSetor").value;
    const filtroStatus = document.getElementById("filtroStatus").value;

    const snap = await db.collection("produtos").get();
    const produtos = snap.docs.map(d => d.data());
    let filtrados = produtos;

    if (filtroLoja) filtrados = filtrados.filter(p => p.loja === filtroLoja);
    if (filtroSetor) filtrados = filtrados.filter(p => p.setor === filtroSetor);
    if (filtroStatus) filtrados = filtrados.filter(p => p.status === filtroStatus);

    // tabela HTML
    let html = `
      <table border="1" cellpadding="6" cellspacing="0" style="width:100%;text-align:left;color:#eee;border-color:#333;">
        <tr style="background:#00ffff33;color:#0ff;">
          <th>Produto</th><th>Lote</th><th>Setor</th><th>Validade</th>
          <th>Status</th><th>Loja</th><th>WhatsApp Gerente</th><th>Respons√°vel</th>
        </tr>
    `;
    filtrados.forEach(p => {
      html += `
        <tr>
          <td>${p.nome || ""}</td>
          <td>${p.lote || ""}</td>
          <td>${p.setor || ""}</td>
          <td>${p.validade || ""}</td>
          <td>${p.status || ""}</td>
          <td>${p.loja || ""}</td>
          <td>${p.whatsGerente || ""}</td>
          <td>${p.whatsResponsavel || ""}</td>
        </tr>
      `;
    });
    html += "</table>";

    document.getElementById("tabelaAdmin").innerHTML = html;

    // gr√°fico de resumo por loja
    const resumo = {};
    filtrados.forEach(p => {
      resumo[p.loja || "Sem Loja"] = (resumo[p.loja || "Sem Loja"] || 0) + 1;
    });

    const ctx = document.getElementById("grafAdmin");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(resumo),
        datasets: [{
          label: "Produtos Cadastrados por Loja",
          data: Object.values(resumo),
          backgroundColor: "rgba(0,255,255,0.4)",
          borderColor: "#00ffff",
          borderWidth: 2
        }]
      },
      options: {
        plugins: { legend: { labels: { color: "#0ff" } } },
        scales: {
          x: { ticks: { color: "#fff" } },
          y: { ticks: { color: "#fff" } }
        }
      }
    });
  }

  document.getElementById("btnFiltrar").addEventListener("click", gerarTabelaEGr√°fico);
  gerarTabelaEGr√°fico();
</script>


<!-- === PARTE 6 ‚Äî PAINEL DO GERENTE + LEITOR + WHATSAPP === -->
<script>
// === Inicializa√ß√£o do leitor de c√≥digo de barras ===
const video = document.createElement("video");
video.style.display = "none";
document.body.appendChild(video);

async function iniciarCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    await video.play();
  } catch (e) {
    alert("Erro ao acessar a c√¢mera: " + e.message);
  }
}

// Exemplo simples de leitor (pode ser substitu√≠do por QuaggaJS para leitura real)
async function lerCodigoBarras() {
  alert("Abra a c√¢mera e aponte para o c√≥digo de barras (demo)");
  iniciarCamera();
  // Aqui pode-se integrar QuaggaJS para leitura real
  const codigo = prompt("Digite o c√≥digo de barras lido:");
  document.getElementById("codigoProduto").value = codigo;
}

// === Formul√°rio de cadastro do produto ===
const painelGerente = document.createElement("section");
painelGerente.id = "painelGerente";
painelGerente.innerHTML = `
  <h2>üßæ Cadastro de Produto</h2>
  <form id="formProduto">
    <input id="codigoProduto" placeholder="C√≥digo de Barras" required>
    <button type="button" onclick="lerCodigoBarras()">üì∑ Ler C√≥digo</button><br>
    <input id="nomeProduto" placeholder="Nome do Produto" required><br>
    <input id="setorProduto" placeholder="Setor" required><br>
    <input id="loteProduto" placeholder="Lote" required><br>
    <input id="validadeProduto" type="date" required><br>
    <input id="fotoProduto" type="file" accept="image/*"><br>
    <input id="lojaProduto" placeholder="Loja" required><br>
    <button type="submit">Salvar Produto</button>
  </form>
`;
document.body.appendChild(painelGerente);

// === Upload da foto e cadastro no Firestore ===
const form = document.getElementById("formProduto");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = nomeProduto.value.trim();
  const setor = setorProduto.value.trim();
  const lote = loteProduto.value.trim();
  const validade = validadeProduto.value;
  const codigo = codigoProduto.value;
  const loja = lojaProduto.value;
  const arquivo = fotoProduto.files[0];
  let fotoURL = "";

  if (arquivo) {
    const ref = storage.ref("fotos/" + arquivo.name);
    await ref.put(arquivo);
    fotoURL = await ref.getDownloadURL();
  }

  const diasRestantes = diferencaDias(validade);
  const status = diasRestantes <= 0 ? "vencido" : "ativo";

  await db.collection("produtos").add({
    nome, setor, lote, validade, codigo, loja,
    foto: fotoURL, status, criadoEm: new Date().toISOString()
  });

  alert("Produto cadastrado com sucesso!");
  form.reset();

  if (diasRestantes === 5) {
    enviarWhatsAppResponsavel({ nome, setor, validade, loja, lote });
  }
});

// === Fun√ß√£o para enviar mensagem no WhatsApp ===
function enviarWhatsAppResponsavel(produto) {
  const mensagem = `üö® *ALERTA DE PRODUTO A VENCER (5 dias)* üö®
Produto: ${produto.nome}
Setor: ${produto.setor}
Lote: ${produto.lote}
Validade: ${produto.validade}
Loja: ${produto.loja}

Por favor, realizar a rebaixa de pre√ßo.`;

  // WhatsApp do respons√°vel cadastrado (pode vir do perfil do gerente)
  const numeroResponsavel = prompt("Informe o WhatsApp do respons√°vel pela rebaixa:");
  if (!numeroResponsavel) return alert("N√∫mero n√£o informado!");

  const url = `https://wa.me/${numeroResponsavel.replace(/\D/g, '')}?text=${encodeURIComponent(mensagem)}`;
  window.open(url, "_blank");
}

function diferencaDias(dataVal) {
  const hoje = new Date();
  const validade = new Date(dataVal);
  return Math.floor((validade - hoje) / (1000 * 60 * 60 * 24));
}
</script>

<script src="particles.js"></script>
<canvas id="particles"></canvas>

<script>
  // === MENU HAMB√öRGUER E NAVEGA√á√ÉO ===
  function toggleMenu() {
    const menu = document.getElementById("menu");
    menu.classList.toggle("active");
  }

  function showSection(sectionId) {
    // Esconde todas as se√ß√µes
    document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
    // Mostra apenas a se√ß√£o clicada
    const target = document.getElementById(sectionId);
    if (target) target.classList.add("active");
    // Fecha o menu no mobile
    document.getElementById("menu").classList.remove("active");
  }

  // Exibe o Dashboard por padr√£o
  document.addEventListener("DOMContentLoaded", () => {
    showSection("dashboard");
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>

</script>
</body>
</html>
